C51 COMPILER V9.60.7.0   MODEAGEFUNCTION                                                   07/19/2024 17:31:56 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE MODEAGEFUNCTION
OBJECT MODULE PLACED IN .\obj\ModeAgeFunction.obj
COMPILER INVOKED BY: D:\Keil_v5\C51\BIN\C51.EXE src\ModeAgeFunction.c LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(.\Drivers\in
                    -c;.\Drivers\src;.\src;.\inc) DEBUG OBJECTEXTEND PRINT(.\list\ModeAgeFunction.lst) TABS(2) OBJECT(.\obj\ModeAgeFunction.o
                    -bj)

line level    source

   1          #include "Global.h"
   2          /*--------------------------------------------------------------*/
   3          uint8_t AgingState,AgeMode;
   4          /*--------------------------------------------------------------*/
   5          void IniAgeMode(void)
   6          {
   7   1        FireDisable;
   8   1        CapDisEnable; 
   9   1        FireCounter=0;
  10   1      //  bFlashUpdate=1;
  11   1      //  UpdateDataFlash();  
  12   1        KeyValue = 0;
  13   1        FanTurnOn();  
  14   1        CoolEnable;
  15   1        ErrorState=0;   
  16   1        CounterS=0;
  17   1        DelayStandby=0;
  18   1        CapChgDsgCnt=0;
  19   1        AgingState=0;
  20   1        AgeMode=0;
  21   1        AgingFireCounter=0;
  22   1        IniLedMode(LedWorking);
  23   1        LedController();
  24   1        MainState=AgingMode;
  25   1      }
  26          /*--------------------------------------------------------------*/
  27          void ModeAgingFunction(void)
  28          {
  29   1        if(KeyValue==KeyOnOffValue) {IniTurnOffMode();return; }
  30   1        if(MainState!=AgingMode) return;
  31   1        if(FanState == FanStateError) { ErrorState=FanVError; IniWarningMode();return;}
  32   1        if(VinState == VinLow || VinState ==VinHigh) {ErrorState=VinVolError;IniWarningMode();return;}
  33   1        if(NtcState != NtcTemNormal){ErrorState=NtcError; TemState=2; IniWarningMode(); return;}
  34   1        /*------------------------------------------------------------------------------*/
  35   1        switch(AgingState)
  36   1        {
  37   2          case 0:
  38   2          {
  39   3            CoolEnable;
  40   3            ConstantVoltageControl();
  41   3            CheckCapChargeState();
  42   3            if(CapChargeState==1)
  43   3            {
  44   4      //        if(DelayCapChgDsg<500)  //Judge to leave out Fire
  45   4      //        {
  46   4      //          if(++CapChgDsgCnt>=10)
  47   4      //          {
  48   4      //            ErrorState=CapError;
  49   4      //            IniWarningMode();
  50   4      //            return;
  51   4      //          }
  52   4      //        }
  53   4      //        else CapChgDsgCnt=0;
C51 COMPILER V9.60.7.0   MODEAGEFUNCTION                                                   07/19/2024 17:31:56 PAGE 2   

  54   4              CapChargeState=0;
  55   4              DelayStandby=0;
  56   4              CapChargeState=0;
  57   4              StopPwmOutput();
  58   4              FireEnable;
  59   4              DelayDisCHG=0;
  60   4              DisChargeCounter=0;
  61   4              StateDelay=0;
  62   4              LedSmartState=1;
  63   4              LedDelay=0;       
  64   4              /*-----------------------------------------------------------------*/
  65   4              // wait for discharge over.
  66   4              while(1)
  67   4              {
  68   5                WDT_Clear();   
  69   5                ReadVoutVoltage(20);
  70   5                if(VoutVoltageValue < ReBoostVol)   //150v
  71   5                {
  72   6                  if(++DisChargeCounter>=1)
  73   6                  {
  74   7                    AgingFireCounter++;
  75   7                    if(AgingFireCounter>=FireTimes)
  76   7                    {
  77   8                      AgingFireCounter=FireTimes;             
  78   8                      while(1)
  79   8                      {
  80   9                        WDT_Clear();
  81   9                        CoolDisable;
  82   9                        LedController();
  83   9                        CheckVinState();    
  84   9                        CheckNtcState();
  85   9      //                  ScanKeyInput();
  86   9                        if(KeyValue==KeyOnOffValue)
  87   9                        {
  88  10                          IniTurnOffMode();
  89  10                          KeyState=KeyPress;KeyValue=0;KeyBuffer0=0;KeyBuffer1=0;
  90  10                          break;
  91  10                        }
  92   9                      }
  93   8                      AgingFireCounter=0; 
  94   8      //                bFlashUpdate=1;
  95   8      //                UpdateDataFlash();
  96   8                    }
  97   7                    if(MainState!=AgingMode) return;
  98   7      //              bFlashUpdate=1;
  99   7                    if(AgeMode==1)
 100   7                    {
 101   8                      if(AgingFireCounter<200) {  GearState=0;}
 102   8                      else if(AgingFireCounter<400) { GearState=4;}
 103   8                      else
 104   8                      {
 105   9                        while(1)
 106   9                        {
 107  10                          WDT_Clear();
 108  10                          CoolDisable;
 109  10                          LedController();
 110  10                          CheckVinState();    
 111  10                          CheckNtcState();
 112  10      //                    ScanKeyInput();
 113  10                          if(KeyValue==KeyOnOffValue)
 114  10                          {
 115  11                            IniTurnOffMode();
C51 COMPILER V9.60.7.0   MODEAGEFUNCTION                                                   07/19/2024 17:31:56 PAGE 3   

 116  11                            KeyState=KeyPress;KeyValue=0;KeyBuffer0=0;KeyBuffer1=0;
 117  11                            break;
 118  11                          }
 119  10                        }
 120   9                        AgingFireCounter=0; 
 121   9      //                  bFlashUpdate=1;
 122   9      //                  UpdateDataFlash();
 123   9                      }
 124   8                    }
 125   7                    if(MainState!=AgingMode) return;
 126   7                    DelaymS=0;while(DelaymS<200) {CLR_WDT; }
 127   7      //              LedState=LedFlash;
 128   7                    LedSmartState=0;//LedSmartState=2;
 129   7                    DisChgErrorCnt=0;
 130   7                    FireDisable;              
 131   7                    BlinkCapChargeStart();
 132   7                    return;
 133   7                  }
 134   6                }
 135   5                else
 136   5                {
 137   6                  DisChargeCounter=0;
 138   6                  if(DelayDisCHG>25)
 139   6                  {
 140   7                    DelayDisCHG=0;
 141   7                    if(bDisState==1) {bDisState=0;FireDisable;}
 142   7                    else {bDisState=1;FireEnable;}
 143   7                  }
 144   6                }
 145   5                if(MainState!=AgingMode) return;
 146   5                if(StateDelay>5000)
 147   5                {
 148   6                  ++DisChgErrorCnt;
 149   6                  if(DisChgErrorCnt>=5)
 150   6                  {
 151   7                    ErrorState=LeakError;
 152   7                    IniWarningMode();
 153   7                  }
 154   6                  else
 155   6                  {
 156   7                    LedSmartState=0;//LedSmartState=2;
 157   7                    FireDisable;
 158   7                    BlinkCapChargeStart();
 159   7                  }
 160   6                  return;
 161   6                }
 162   5              }
 163   4              /*-----------------------------------------------------------------*/           
 164   4            }
 165   3            else
 166   3            {
 167   4              if(DelayCapChgDsg>=10000)
 168   4              {
 169   5                ErrorState=CapError;
 170   5                IniWarningMode();
 171   5                return;
 172   5              }
 173   4      //        LedState=LedSolidOff;
 174   4              LedSmartState=0;
 175   4            }
 176   3            return;
 177   3            }
C51 COMPILER V9.60.7.0   MODEAGEFUNCTION                                                   07/19/2024 17:31:56 PAGE 4   

 178   2            /*------------------------------------------------------------------------------*/
 179   2            case 1:
 180   2            {
 181   3              CoolDisable;
 182   3              if(RestTime>=StopTime)
 183   3              {
 184   4                AgingState=0;
 185   4                CoolEnable;
 186   4      //          LedState=LedFlash;
 187   4                LedSmartState=0;//LedSmartState=2;
 188   4                DisChgErrorCnt=0;
 189   4                FireDisable;
 190   4                BlinkCapChargeStart();
 191   4              }
 192   3              FireDisable;
 193   3            }
 194   2            default: {break;}
 195   2          }
 196   1      }
 197          
 198          /*--------------------------------------------------------------*/


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    747    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      2    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
